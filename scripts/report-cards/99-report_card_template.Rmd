---
fontsize: 12pt
header-includes:
mainfont: Arial
output:
  pdf_document:
    latex_engine: xelatex
    includes:
      in_header: "preamble.tex"
params:
  reef: Torres Strait
  standalone: yes
---

\thispagestyle{headerandfooter}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, dpi = 300, fig.align = "center", out.width = "100%")
options(scipen = 999)
```

```{r data, eval = params$standalone}
source(here::here("scripts", "report-cards", "99-report_card_setup.R"))
```

```{r bcu-data}
bcu <- bcus[[params$reef]]
bcu_ext <- bcus_ext[[params$reef]]

tile_indicator <- bcus_tiles_indicator[[params$reef]]

bcu_top_threats <- top_threats[[params$reef]]

bcu_prefs <- bcus_prefs[[params$reef]]

bcu_percentiles <- bcus_percentiles[[params$reef]]

bcu_name <- recode_bcus(params$reef)

bcu_wcs_map <- bcus_wcs_maps %>% 
  filter(bcu == params$reef) %>%
  pull(wcs_map)
```

# `r bcu_name`

```{r, out.height = "3in", eval = length(bcu_wcs_map) == 1}
knitr::include_graphics(here::here("data", "report-cards", "wcs-maps", glue("{bcu_wcs_map}.jpg")))
```

## Global Threat Indicators

```{r, warning = FALSE, message = FALSE, fig.height = 1.8}
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow = 1, ncol = 3, widths = c(1/3, 1/3, 1/3))))

print(map_indicator(bcu, tile_indicator, "grav_NC", "Fishing:\nMarket Pressure", bcu_ext), vp = viewport(layout.pos.col = 1, layout.pos.row = 1))

print(map_indicator(bcu, tile_indicator, "sediment", "Pollution:\nSedimentation", bcu_ext), vp = viewport(layout.pos.col = 2, layout.pos.row = 1))

print(map_indicator(bcu, tile_indicator, "nutrient", "Pollution:\nNutrients", bcu_ext), vp = viewport(layout.pos.col = 3, layout.pos.row = 1))

pushViewport(viewport(layout.pos.col = 3, layout.pos.row = 1))
```

\vspace{-0.45in}

```{r, fig.height = 0.6}
generate_map_legend("grav_NC") + generate_map_legend("sediment") +
  generate_map_legend("nutrient") + plot_layout(nrow = 1, widths = c(1 / 3, 1 / 3, 1 / 3))
```

\vspace{-0.45in}

```{r, warning = FALSE, message = FALSE, fig.height = 1.9}
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow = 1, ncol = 3, widths = c(1/3, 1/3, 1/3))))

print(map_indicator(bcu, tile_indicator, "pop_count", "Coastal Development:\nHuman Population", bcu_ext), vp = viewport(layout.pos.col = 1, layout.pos.row = 1))

print(map_indicator(bcu, tile_indicator, "num_ports", "Industrial Development:\nPorts", bcu_ext), vp = viewport(layout.pos.col = 2, layout.pos.row = 1))

print(map_indicator(bcu, tile_indicator, "reef_value", "Tourism:\nReef Value", bcu_ext), vp = viewport(layout.pos.col = 3, layout.pos.row = 1))

pushViewport(viewport(layout.pos.col = 3, layout.pos.row = 1))
```

\vspace{-0.45in}

```{r, fig.height = 0.6}
generate_map_legend("pop_count") + generate_map_legend("num_ports") + generate_map_legend("reef_value") + plot_layout(nrow = 1, widths = c(1 / 3, 1 / 3, 1 / 3))
```

\clearpage
\enlargethispage{4\baselineskip}

## Top Two Threats

```{r}
first_threat <- bcu_top_threats %>%
  filter(rank == 1) %>%
  pull(indicator_label)

second_threat <- bcu_top_threats %>%
  filter(rank == 2) %>%
  pull(indicator_label)
```

1. `r first_threat`

2. `r second_threat`

## Threat Ranking

```{r, fig.height = 3}
plot_threat_ranking_percentiles(bcu_percentiles, bcu_top_threats)
```

\vspace{-0.35in}

## Global Context

```{r, warning = FALSE}
indicator_plots <- lapply(c(
  "grav_NC", "sediment", "nutrient",
  "pop_count", "num_ports", "reef_value"
), function(x) plot_indicator_dumbbell(top_threats, bcus_regions, params$reef, x))

climate_plots <- lapply(c(
  "score", "scorecn", "scorecy", "scorepfc",
  "scoreth", "scoretr"
), function(x) plot_indicator_dumbbell(top_threats, bcus_regions, params$reef, x))
```

```{r, fig.height = 0.5}
ggpubr::get_legend(indicator_plots[[1]]) %>%
  ggpubr::as_ggplot()
```

\vspace{-0.45in}

```{r, warning = FALSE, fig.height = 4}
wrap_plots(append(indicator_plots, climate_plots),
  ncol = 2, byrow = FALSE, widths = c(0.5, 0.5)
) +
  plot_layout(guides = "collect") &
  theme(
    legend.position = "none", legend.box = "horizontal"
  )
```

